---
import BaseLayout from './BaseLayout.astro';
import NavPill from '../components/NavPill.astro';
import MediaLightbox from '../components/MediaLightbox.astro';
import EmblemCard from '../components/EmblemCard.astro';

interface Props {
  title: string;
  description: string;
  section: string;
  initialSlug?: string;
  initialEmblem?: string;
}

const { title, description, section, initialSlug, initialEmblem } = Astro.props;
const hasInitialContent = Astro.slots.has('detail');
---

<BaseLayout title={title} description={description}>
  <NavPill />
  <div
    class:list={['split-view', { 'has-selection': hasInitialContent }]}
    data-section={section}
    data-initial-slug={initialSlug}
  >
    <!-- Left Panel: List -->
    <aside class="split-view__list">
      <header class="split-view__header">
        <h1 class="split-view__title">{title}</h1>
      </header>
      <div class="split-view__filter">
        <div class="split-view__search-wrapper">
          <span class="split-view__search-icon">⌕</span>
          <input
            type="search"
            class="split-view__search"
            placeholder="Search..."
            aria-label="Search entries"
          />
        </div>
        <div class="split-view__type-filter">
          <button class="split-view__type-toggle" type="button" aria-expanded="false">
            <span class="split-view__type-label">Type</span>
            <span class="split-view__type-chevron">▾</span>
          </button>
          <div class="split-view__type-dropdown" hidden>
            <div class="split-view__type-list"></div>
            <button class="split-view__type-clear" type="button">Clear all</button>
          </div>
        </div>
        <div class="split-view__tags-filter">
          <button class="split-view__tags-toggle" type="button" aria-expanded="false">
            <span class="split-view__tags-label">Tags</span>
            <span class="split-view__tags-chevron">▾</span>
          </button>
          <div class="split-view__tags-dropdown" hidden>
            <div class="split-view__tags-list"></div>
            <button class="split-view__tags-clear" type="button">Clear all</button>
          </div>
        </div>
        <button class="split-view__clear-all-filters" type="button" hidden>
          <span class="split-view__clear-all-icon">✕</span>
          <span class="split-view__clear-all-label">Clear All</span>
        </button>
      </div>
      <div class="split-view__no-results" hidden>
        <p>No matching entries</p>
      </div>
      <nav class="split-view__nav" role="list">
        <slot name="list" />
      </nav>
    </aside>

    <!-- Center Panel: Detail -->
    <main class="split-view__detail">
      <div class="split-view__detail-inner">
        <div class="split-view__placeholder">
          <div class="split-view__placeholder-content">
            <span class="split-view__placeholder-icon">→</span>
            <p class="split-view__placeholder-title">Select an item to view details</p>
          </div>
        </div>
        <article class:list={['split-view__content', { 'is-active': hasInitialContent }]} aria-live="polite">
          {hasInitialContent ? <slot name="detail" /> : null}
        </article>
      </div>
    </main>

    <!-- Right Panel: Emblem -->
    <aside class="split-view__emblem">
      <EmblemCard emblemSrc={initialEmblem} isInitiallyFlipped={hasInitialContent} />
    </aside>

    <!-- Mobile Emblem Badge -->
    <div class="emblem-badge" data-emblem-badge>
      <EmblemCard emblemSrc={initialEmblem} isInitiallyFlipped={hasInitialContent} />
    </div>
  </div>
  <MediaLightbox />
</BaseLayout>

<style is:global>
  /* Remove page padding when split-view is active */
  .page:has(.split-view) {
    padding: 0;
  }

  .split-view {
    display: grid;
    grid-template-columns: 380px 1fr 240px;
    min-height: 100vh;
    gap: 0;
  }

  /* Left Panel */
  .split-view__list {
    background: var(--color-bg-elevated);
    border-right: var(--border-thick) solid var(--color-gold-dim);
    display: flex;
    flex-direction: column;
    height: 100vh;
    position: sticky;
    top: 0;
  }

  .split-view__header {
    padding: var(--space-lg) var(--space-md);
    border-bottom: var(--border-medium) solid var(--color-gold);
    background: var(--color-gold);
  }

  .split-view__title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    color: var(--color-black);
    text-transform: uppercase;
    margin-bottom: 0;
    line-height: 1.3;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }


  .split-view__nav {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-sm) 0;
  }

  /* Filter UI */
  .split-view__filter {
    display: flex;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-bg-surface);
    border-bottom: var(--border-thin) solid var(--color-border);
  }

  .split-view__search-wrapper {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
  }

  .split-view__search-icon {
    position: absolute;
    left: var(--space-sm);
    color: var(--color-text-muted);
    font-size: var(--text-sm);
    pointer-events: none;
  }

  .split-view__search {
    width: 100%;
    padding: var(--space-xs) var(--space-sm) var(--space-xs) var(--space-xl);
    background: var(--color-bg-base);
    border: var(--border-thin) solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  }

  .split-view__search::placeholder {
    color: var(--color-text-muted);
  }

  .split-view__search:focus {
    outline: none;
    border-color: var(--color-gold);
    box-shadow: 0 0 0 2px rgba(255, 229, 44, 0.2);
  }

  /* Type Filter */
  .split-view__type-filter {
    position: relative;
  }

  .split-view__type-toggle {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-bg-base);
    border: var(--border-thin) solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-muted);
    font-family: var(--font-display);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: border-color var(--transition-fast), color var(--transition-fast);
  }

  .split-view__type-toggle:hover {
    border-color: var(--color-gold-dim);
    color: var(--color-text);
  }

  .split-view__type-toggle[aria-expanded="true"] {
    border-color: var(--color-gold);
    color: var(--color-gold);
  }

  .split-view__type-toggle.has-selection {
    background: var(--color-gold);
    border-color: var(--color-gold);
    color: var(--color-black);
  }

  .split-view__type-chevron {
    font-size: var(--text-xs);
    transition: transform var(--transition-fast);
  }

  .split-view__type-toggle[aria-expanded="true"] .split-view__type-chevron {
    transform: rotate(180deg);
  }

  .split-view__type-dropdown {
    position: absolute;
    top: calc(100% + var(--space-xs));
    right: 0;
    min-width: 160px;
    max-width: 220px;
    max-height: 300px;
    overflow-y: auto;
    background: var(--color-bg-elevated);
    border: var(--border-medium) solid var(--color-gold-dim);
    border-radius: var(--radius-md);
    padding: var(--space-sm);
    z-index: 100;
    box-shadow: var(--shadow-hard);
  }

  .split-view__type-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
    margin-bottom: var(--space-sm);
  }

  .split-view__type-pill {
    padding: var(--space-2xs) var(--space-sm);
    background: var(--color-bg-surface);
    border: var(--border-thin) solid var(--color-border);
    border-radius: var(--radius-pill);
    color: var(--color-text-muted);
    font-family: var(--font-body);
    font-size: var(--text-xs);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-transform: capitalize;
  }

  .split-view__type-pill:hover {
    border-color: var(--color-gold-dim);
    color: var(--color-text);
  }

  .split-view__type-pill.is-selected {
    background: var(--color-gold);
    border-color: var(--color-gold);
    color: var(--color-black);
    font-weight: 500;
  }

  .split-view__type-clear {
    width: 100%;
    padding: var(--space-xs);
    background: transparent;
    border: var(--border-thin) solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-muted);
    font-family: var(--font-display);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .split-view__type-clear:hover {
    border-color: var(--color-gold-dim);
    color: var(--color-text);
  }

  /* Tags Filter */
  .split-view__tags-filter {
    position: relative;
  }

  .split-view__tags-toggle {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-bg-base);
    border: var(--border-thin) solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-muted);
    font-family: var(--font-display);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: border-color var(--transition-fast), color var(--transition-fast);
  }

  .split-view__tags-toggle:hover {
    border-color: var(--color-gold-dim);
    color: var(--color-text);
  }

  .split-view__tags-toggle[aria-expanded="true"] {
    border-color: var(--color-gold);
    color: var(--color-gold);
  }

  .split-view__tags-toggle.has-selection {
    background: var(--color-gold);
    border-color: var(--color-gold);
    color: var(--color-black);
  }

  .split-view__tags-chevron {
    font-size: var(--text-xs);
    transition: transform var(--transition-fast);
  }

  .split-view__tags-toggle[aria-expanded="true"] .split-view__tags-chevron {
    transform: rotate(180deg);
  }

  .split-view__tags-dropdown {
    position: absolute;
    top: calc(100% + var(--space-xs));
    right: 0;
    min-width: 200px;
    max-width: 280px;
    max-height: 300px;
    overflow-y: auto;
    background: var(--color-bg-elevated);
    border: var(--border-medium) solid var(--color-gold-dim);
    border-radius: var(--radius-md);
    padding: var(--space-sm);
    z-index: 100;
    box-shadow: var(--shadow-hard);
  }

  .split-view__tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
    margin-bottom: var(--space-sm);
  }

  .split-view__tag-pill {
    padding: var(--space-2xs) var(--space-sm);
    background: var(--color-bg-surface);
    border: var(--border-thin) solid var(--color-border);
    border-radius: var(--radius-pill);
    color: var(--color-text-muted);
    font-family: var(--font-body);
    font-size: var(--text-xs);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .split-view__tag-pill:hover {
    border-color: var(--color-gold-dim);
    color: var(--color-text);
  }

  .split-view__tag-pill.is-selected {
    background: var(--color-gold);
    border-color: var(--color-gold);
    color: var(--color-black);
    font-weight: 500;
  }

  .split-view__tags-clear {
    width: 100%;
    padding: var(--space-xs);
    background: transparent;
    border: var(--border-thin) solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-muted);
    font-family: var(--font-display);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .split-view__tags-clear:hover {
    border-color: var(--color-gold-dim);
    color: var(--color-text);
  }

  /* Clear All Filters Button */
  .split-view__clear-all-filters {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: rgba(255, 229, 44, 0.1);
    border: var(--border-thin) solid var(--color-gold-dim);
    border-radius: var(--radius-sm);
    color: var(--color-gold);
    font-family: var(--font-display);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-top: var(--space-xs);
  }

  .split-view__clear-all-filters:hover {
    background: rgba(255, 229, 44, 0.2);
    border-color: var(--color-gold);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(255, 229, 44, 0.2);
  }

  .split-view__clear-all-filters[hidden] {
    display: none;
  }

  .split-view__clear-all-icon {
    font-size: var(--text-sm);
    line-height: 1;
  }

  .split-view__clear-all-label {
    font-weight: 500;
  }

  .split-view__no-results {
    padding: var(--space-xl) var(--space-md);
    text-align: center;
    color: var(--color-text-muted);
    font-style: italic;
  }

  .split-view__no-results[hidden] {
    display: none;
  }

  /* Hide list items when filtered out */
  .list-item.is-filtered {
    display: none !important;
  }

  /* Right Panel */
  .split-view__detail {
    background: var(--color-bg-base);
    padding: var(--space-xl) var(--space-2xl);
    padding-bottom: calc(var(--space-3xl) + 80px);
    overflow-y: auto;
  }

  .split-view__detail-inner {
    /* No max-width - let entry layout handle its own constraints */
  }

  /* Emblem Panel (Right Sidebar) */
  .split-view__emblem {
    position: sticky;
    top: 0;
    height: 100vh;
    padding: var(--space-xl) var(--space-lg);
    background: var(--color-bg-elevated);
    border-left: var(--border-thick) solid var(--color-gold-dim);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  /* Mobile floating badge - hidden on desktop */
  .emblem-badge {
    display: none;
  }

  /* Entry content within split view */
  .split-view__content .entry {
    padding-bottom: 0;
    max-width: 720px;
  }

  .split-view__content .container {
    padding: 0;
    max-width: none;
  }

  /* Inline media in markdown prose - consistent sizing with constraints */
  .split-view__content .prose img,
  .split-view__content .prose video {
    display: block;
    width: 100%;
    min-width: 280px;
    max-width: 560px;
    height: auto;
    margin: var(--space-xl) 0;
    border-radius: var(--radius-md);
    border: var(--border-medium) solid var(--color-border-strong);
    cursor: pointer;
    transition:
      border-color var(--transition-fast),
      box-shadow var(--transition-fast),
      transform var(--transition-base);
    transform-style: preserve-3d;
    will-change: transform;
  }

  .split-view__content .prose img:hover,
  .split-view__content .prose video:hover {
    border-color: var(--color-gold-dim);
    box-shadow:
      var(--shadow-hard-sm),
      0 0 20px rgba(255, 229, 44, 0.15);
    transform: perspective(800px) rotateY(2deg) rotateX(-1deg) scale(1.02);
  }

  @media (prefers-reduced-motion: reduce) {
    .split-view__content .prose img:hover,
    .split-view__content .prose video:hover {
      transform: scale(1.01);
    }
  }

  /* Video-specific styling */
  .split-view__content .prose video {
    background: var(--color-bg-elevated);
  }

  /* Smaller inline images (use ![alt](src){.small} in markdown) */
  .split-view__content .prose img.small {
    min-width: 200px;
    max-width: 320px;
  }

  /* Full-width images */
  .split-view__content .prose img.full {
    min-width: 280px;
    max-width: 100%;
  }

  /* Mobile: reduce minimum size */
  @media (max-width: 768px) {
    .split-view__content .prose img,
    .split-view__content .prose video {
      min-width: 200px;
    }

    .split-view__content .prose img.small {
      min-width: 150px;
    }
  }

  .split-view__content .entry__header {
    margin-bottom: var(--space-2xl);
    padding-bottom: var(--space-lg);
    border-bottom: var(--border-thin) solid var(--color-border);
  }

  .split-view__content .entry__title {
    font-size: var(--text-2xl);
    margin-bottom: var(--space-md);
  }

  .split-view__content .entry__meta {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    padding-top: var(--space-md);
    border-top: var(--border-hairline) solid var(--color-border);
  }

  .split-view__content .entry__meta-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-sm);
  }

  .split-view__content .entry__meta-row > * {
    flex-shrink: 0;
  }

  .split-view__content .entry__meta-dates {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xs);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    font-family: var(--font-body);
  }

  .split-view__content .entry__meta-dates .meta-date-item {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .split-view__content .entry__meta-dates .meta-date-label {
    font-weight: 500;
    color: var(--color-text);
    min-width: 100px;
  }

  .split-view__content .entry__meta-dates .meta-date-value {
    color: var(--color-text-muted);
  }

  .split-view__placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 50vh;
    color: var(--color-text-muted);
    text-align: center;
  }

  .split-view__placeholder-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    align-items: center;
    max-width: 50ch;
  }

  .split-view__placeholder-icon {
    font-size: var(--text-4xl);
    opacity: 0.3;
  }

  .split-view__placeholder-title {
    font-size: var(--text-lg);
  }


  .split-view__content {
    display: none;
  }

  .split-view__content.is-active {
    display: block;
    animation: p3r-entrance 400ms cubic-bezier(0.16, 1, 0.3, 1) backwards;
  }

  .split-view.has-selection .split-view__placeholder {
    display: none;
  }

  /* Tablet: Hide emblem sidebar, 2-column layout */
  @media (max-width: 1200px) {
    .split-view {
      grid-template-columns: 380px 1fr;
    }

    .split-view__emblem {
      display: none;
    }

    /* Show mobile badge when content is selected */
    .split-view.has-selection .emblem-badge {
      display: block;
      position: fixed;
      bottom: 100px; /* Above NavPill */
      right: var(--space-md);
      width: 60px;
      z-index: 50;
    }

    .emblem-badge .emblem-card {
      max-width: 60px;
    }
  }

  /* Mobile: Stack layout */
  @media (max-width: 900px) {
    .split-view {
      grid-template-columns: 1fr;
      min-height: auto;
    }

    .split-view__list {
      position: relative;
      height: auto;
      max-height: none;
      border-right: none;
      border-bottom: var(--border-thick) solid var(--color-gold-dim);
    }

    .split-view__nav {
      max-height: 50vh;
    }

    .split-view__detail {
      min-height: 60vh;
    }

    .split-view.has-selection .split-view__list {
      display: none;
    }

    .split-view.has-selection .split-view__detail {
      min-height: 100vh;
    }
  }

  /* ==========================================
     Section-specific styles (available for client-side nav)
     ========================================== */

  /* Entry details (reflections type, mood, etc.) */
  .split-view__content .entry__details {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm) var(--space-lg);
    margin-top: var(--space-md);
    font-size: var(--text-sm);
  }

  .split-view__content .entry__details dt {
    font-family: var(--font-display);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: var(--tracking-label);
    color: var(--color-text-muted);
  }

  .split-view__content .entry__details dd {
    color: var(--color-text);
  }

  /* Showcase: Inquiry frame */
  .split-view__content .inquiry-frame {
    margin-bottom: var(--space-2xl);
    padding: var(--space-lg);
    background: var(--color-bg-elevated);
    border: var(--border-medium) solid var(--color-gold);
    border-radius: var(--radius-md);
  }

  .split-view__content .inquiry-frame dl {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .split-view__content .inquiry-frame__item dt {
    font-family: var(--font-display);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: var(--tracking-label);
    color: var(--color-gold-dim);
    margin-bottom: var(--space-xs);
  }

  .split-view__content .inquiry-frame__item dd {
    color: var(--color-text);
    line-height: 1.6;
  }

  /* Music: Tracklist */
  .split-view__content .tracklist {
    margin-top: var(--space-2xl);
    padding-top: var(--space-xl);
    border-top: var(--border-thin) solid var(--color-border);
  }

  .split-view__content .tracklist h3 {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    margin-bottom: var(--space-md);
    color: var(--color-gold);
  }

  .split-view__content .tracklist ol {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    counter-reset: track;
  }

  .split-view__content .tracklist li {
    display: flex;
    align-items: baseline;
    gap: var(--space-sm);
    padding: var(--space-sm) 0;
    border-bottom: var(--border-hairline) solid var(--color-border);
    counter-increment: track;
  }

  .split-view__content .tracklist li::before {
    content: counter(track) ".";
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    min-width: 2.5ch;
  }

  .split-view__content .track__title {
    font-weight: 500;
    color: var(--color-text);
  }

  .split-view__content .track__artist {
    color: var(--color-text-muted);
    font-size: var(--text-sm);
  }

  .split-view__content .track__link {
    margin-left: auto;
    font-size: var(--text-xs);
    color: var(--color-gold-dim);
    text-transform: uppercase;
    letter-spacing: var(--tracking-label);
    transition: color var(--transition-fast);
  }

  .split-view__content .track__link:hover {
    color: var(--color-gold);
  }

  /* ==========================================
     Component styles for client-side loaded content
     ========================================== */

  /* TagList component */
  .tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }

  .tag-list--sm .tag {
    font-size: var(--text-xs);
    padding: var(--space-xs) var(--space-sm);
  }

  .tag-list--md .tag {
    font-size: var(--text-sm);
    padding: var(--space-xs) var(--space-md);
  }

  .tag {
    font-family: var(--font-body);
    font-weight: 500;
    background: var(--color-bg-surface);
    border: var(--border-thin) solid var(--color-border-strong);
    border-radius: var(--radius-pill);
    color: var(--color-text-muted);
  }

  /* DateDisplay component */
  .date-display {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    font-family: var(--font-body);
    color: var(--color-text-muted);
  }

  .date-display--sm {
    font-size: var(--text-xs);
  }

  .date-display--md {
    font-size: var(--text-sm);
  }

  .date-display__label {
    display: none;
  }

  .date-display__separator {
    opacity: 0.5;
  }

  .date-display__updated {
    font-style: italic;
  }

  /* Visual hierarchy improvements: dim sidebar when scrolling */
  .split-view__list.is-scrolled {
    opacity: 0.7;
    transition: opacity 300ms ease-out;
  }

  /* Visual hierarchy improvements: dim non-active list items when content is selected */
  .split-view.has-selection .list-item:not(.is-active) {
    opacity: 0.6;
    transition: opacity 200ms ease-out;
  }

  /* Reduce hover effect on non-active items when content is selected */
  .split-view.has-selection .list-item:not(.is-active):hover {
    opacity: 0.85;
    box-shadow:
      inset 4px 0 0 var(--color-gold),
      0 0 10px rgba(255, 229, 44, 0.08);
  }

  /* Ensure active item stays prominent */
  .split-view.has-selection .list-item.is-active {
    opacity: 1;
  }
</style>

<script>
  function initSplitView() {
    const splitView = document.querySelector('.split-view') as HTMLElement | null;
    if (!splitView) return;

    // Prevent duplicate initialization
    if ((splitView as any).__splitViewInitialized) return;
    (splitView as any).__splitViewInitialized = true;

    const section = splitView.dataset.section || '';
    const initialSlug = splitView.dataset.initialSlug;
    const searchInput = splitView.querySelector('.split-view__search') as HTMLInputElement | null;
    const typesList = splitView.querySelector('.split-view__type-list') as HTMLElement | null;
    const typeToggle = splitView.querySelector('.split-view__type-toggle') as HTMLElement | null;
    const typeDropdown = splitView.querySelector('.split-view__type-dropdown') as HTMLElement | null;
    const typeClear = splitView.querySelector('.split-view__type-clear') as HTMLElement | null;
    const typeFilter = splitView.querySelector('.split-view__type-filter') as HTMLElement | null;
    const tagsList = splitView.querySelector('.split-view__tags-list') as HTMLElement | null;
    const tagsToggle = splitView.querySelector('.split-view__tags-toggle') as HTMLElement | null;
    const tagsDropdown = splitView.querySelector('.split-view__tags-dropdown') as HTMLElement | null;
    const tagsClear = splitView.querySelector('.split-view__tags-clear') as HTMLElement | null;
    const tagsFilter = splitView.querySelector('.split-view__tags-filter') as HTMLElement | null;
    const clearAllButton = splitView.querySelector('.split-view__clear-all-filters') as HTMLElement | null;
    const noResults = splitView.querySelector('.split-view__no-results') as HTMLElement | null;
    const contentArea = splitView.querySelector('.split-view__content') as HTMLElement | null;
    const listItems = Array.from(splitView.querySelectorAll('.list-item')) as HTMLElement[];
    const navContainer = splitView.querySelector('.split-view__nav') as HTMLElement | null;
    const listPanel = splitView.querySelector('.split-view__list') as HTMLElement | null;

    if (!searchInput || !typesList || !typeToggle || !typeDropdown || !typeClear || !typeFilter || !tagsList || !tagsToggle || !tagsDropdown || !tagsClear || !tagsFilter || !clearAllButton || !noResults || !contentArea) {
      console.error('Split view: missing required elements');
      return;
    }

    let currentSlug: string | null = initialSlug || null;
    let isAnimating = false; // Track animation state

    // Get filter state from URL
    function getFiltersFromURL() {
      const params = new URLSearchParams(window.location.search);
      const search = params.get('search') || '';
      const tagsParam = params.get('tags') || '';
      const typesParam = params.get('types') || '';
      const tags = tagsParam ? new Set(tagsParam.split(',').filter(Boolean)) : new Set<string>();
      const types = typesParam ? new Set(typesParam.split(',').filter(Boolean)) : new Set<string>();
      return { search, tags, types };
    }

    // Update URL with current filters
    function updateURL(search: string, tags: Set<string>, types: Set<string>) {
      const params = new URLSearchParams(window.location.search);

      if (search) {
        params.set('search', search);
      } else {
        params.delete('search');
      }

      if (tags.size > 0) {
        params.set('tags', Array.from(tags).sort().join(','));
      } else {
        params.delete('tags');
      }

      if (types.size > 0) {
        params.set('types', Array.from(types).sort().join(','));
      } else {
        params.delete('types');
      }

      const newURL = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
      history.replaceState(null, '', newURL);

      // Show/hide clear all button based on active filters
      const hasActiveFilters = tags.size > 0 || types.size > 0;
      clearAllButton!.hidden = !hasActiveFilters;
    }

    // Populate types dropdown and restore selected state
    function populateTypes(selectedTypes: Set<string>) {
      const allTypes = new Set<string>();
      listItems.forEach((item) => {
        const type = item.dataset.contentType;
        if (type) allTypes.add(type);
      });

      const sortedTypes = Array.from(allTypes).sort();
      typesList!.innerHTML = sortedTypes
        .map((type) => {
          const isSelected = selectedTypes.has(type);
          return `<button class="split-view__type-pill ${isSelected ? 'is-selected' : ''}" type="button" data-type="${type}">${type}</button>`;
        })
        .join('');

      typeFilter!.style.display = sortedTypes.length === 0 ? 'none' : '';
      typeToggle!.classList.toggle('has-selection', selectedTypes.size > 0);
    }

    // Populate tags dropdown and restore selected state
    function populateTags(selectedTags: Set<string>) {
      const allTags = new Set<string>();
      listItems.forEach((item) => {
        const tags = item.dataset.tags?.split(',').filter(Boolean) || [];
        tags.forEach((tag) => allTags.add(tag));
      });

      const sortedTags = Array.from(allTags).sort();
      tagsList!.innerHTML = sortedTags
        .map((tag) => {
          const isSelected = selectedTags.has(tag);
          return `<button class="split-view__tag-pill ${isSelected ? 'is-selected' : ''}" type="button" data-tag="${tag}">${tag}</button>`;
        })
        .join('');

      tagsFilter!.style.display = sortedTags.length === 0 ? 'none' : '';
      tagsToggle!.classList.toggle('has-selection', selectedTags.size > 0);
    }

    // Apply filters based on current URL params
    function applyFilters() {
      const { search, tags, types } = getFiltersFromURL();
      const query = search.toLowerCase().trim();
      let visibleCount = 0;

      listItems.forEach((item) => {
        const title = item.querySelector('.list-item__title')?.textContent?.toLowerCase() || '';
        const itemTags = item.dataset.tags?.split(',').filter(Boolean) || [];
        const itemType = item.dataset.contentType || '';
        const searchContent = item.dataset.searchContent?.toLowerCase() || '';

        // Search in title OR body content
        const matchesSearch = !query || title.includes(query) || searchContent.includes(query);
        const matchesTags = tags.size === 0 || itemTags.some((tag) => tags.has(tag));
        const matchesType = types.size === 0 || types.has(itemType);

        const isVisible = matchesSearch && matchesTags && matchesType;
        item.classList.toggle('is-filtered', !isVisible);
        if (isVisible) visibleCount++;
      });

      noResults!.hidden = visibleCount > 0;
    }

    // Trigger emblem card flip animation - single 360° spin to the right
    // Sequence: emblem (front) → card back → new emblem (front)
    // Returns a promise that resolves when animation completes
    function triggerEmblemFlip(doc?: Document, skipAnimation = false): Promise<void> {
      return new Promise((resolve) => {
        const emblemCards = document.querySelectorAll('[data-emblem-card]');
        if (emblemCards.length === 0) {
          resolve();
          return;
        }

        // Extract emblem source from fetched page if available
        const pageEmblem = doc?.querySelector('[data-page-emblem]');
        const emblemSrc = pageEmblem?.getAttribute('data-src') || '/images/emblems/default.svg';

        const totalDuration = 800; // Total duration for full 360° spin

        // If skipping animation (first load), just update the image directly
        if (skipAnimation) {
          emblemCards.forEach((card) => {
            const frontImg = card.querySelector('[data-emblem-front]') as HTMLImageElement;
            if (frontImg && emblemSrc) {
              frontImg.src = emblemSrc;
            }
            card.classList.add('is-flipped');
          });
          resolve();
          return;
        }

        emblemCards.forEach((card) => {
          const frontImg = card.querySelector('[data-emblem-front]') as HTMLImageElement;
          const flipper = card.querySelector('.emblem-card__flipper') as HTMLElement;
          if (!flipper) return;

          // FIXED ORDER: Disable transitions FIRST, then modify classes/styles
          flipper.style.transition = 'none';
          card.classList.remove('is-flipped');
          flipper.style.transform = 'rotateY(180deg)';

          // Force reflow
          void flipper.offsetWidth;

          // Single smooth spin from 180deg to 540deg (full 360°)
          flipper.style.transition = `transform ${totalDuration}ms cubic-bezier(0.4, 0, 0.2, 1)`;
          flipper.style.transform = 'rotateY(540deg)';

          // Update image near end (after card backing shown, before new emblem visible)
          setTimeout(() => {
            if (frontImg && emblemSrc) {
              frontImg.src = emblemSrc;
            }
          }, totalDuration * 0.5);

          // After animation completes, normalize to 180deg (540 % 360 = 180)
          setTimeout(() => {
            flipper.style.transition = 'none';
            flipper.style.transform = 'rotateY(180deg)';
            card.classList.add('is-flipped');

            // Re-enable transitions after a frame to avoid conflicts
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                flipper.style.transition = '';
                resolve();
              });
            });
          }, totalDuration);
        });
      });
    }

    // Load detail content
    async function loadContent(slug: string) {
      if (!splitView || !contentArea || slug === currentSlug) return;

      // Wait for any ongoing animation to complete
      if (isAnimating) {
        return; // Ignore rapid clicks while animating
      }

      const isFirstLoad = currentSlug === null;

      listItems.forEach((i) => i.classList.remove('is-active'));
      const activeItem = splitView.querySelector(`[data-slug="${slug}"]`);
      activeItem?.classList.add('is-active');

      splitView.classList.add('has-selection', 'is-loading');
      contentArea.classList.remove('is-active');

      try {
        const response = await fetch(`/${section}/${slug}/`);
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const entryContent = doc.querySelector('.entry');

        if (entryContent) {
          contentArea.innerHTML = entryContent.outerHTML;
          contentArea.classList.add('is-active');
          history.pushState({ slug }, '', `/${section}/${slug}/`);
          currentSlug = slug;

          const heading = contentArea.querySelector('h1, h2, .entry__title') as HTMLElement;
          if (heading) {
            heading.setAttribute('tabindex', '-1');
            heading.focus({ preventScroll: true });
          }

          setTimeout(() => initMediaLightbox(), 50);

          // Trigger emblem card flip animation
          // Skip animation on first load to avoid placeholder flash
          isAnimating = true;
          await triggerEmblemFlip(doc, isFirstLoad);
          isAnimating = false;

          // Start floating for newly loaded content
          startFloating();
        }
      } catch (error) {
        console.error('Failed to load content:', error);
        window.location.href = `/${section}/${slug}/`;
      } finally {
        splitView.classList.remove('is-loading');
      }
    }

    // Initialize - restore state from URL
    const { search: initialSearch, tags: initialTags, types: initialTypes } = getFiltersFromURL();
    searchInput.value = initialSearch;
    populateTags(initialTags);
    populateTypes(initialTypes);
    applyFilters();

    if (initialSlug) {
      const activeItem = splitView.querySelector(`[data-slug="${initialSlug}"]`);
      activeItem?.classList.add('is-active');
    }

    // Idle detection for emblem floating
    let isIdle = false;
    let resumeTimer: number | null = null;
    const RESUME_DELAY = 3000; // Resume floating after 3 seconds of inactivity

    function startFloating() {
      // Clear any pending resume timer
      if (resumeTimer) clearTimeout(resumeTimer);

      if (splitView && splitView.classList.contains('has-selection') && !isIdle) {
        isIdle = true;
        document.querySelectorAll('[data-emblem-card]').forEach(card => {
          card.dispatchEvent(new CustomEvent('emblemcard:idle-start'));
        });
      }
    }

    function stopFloating() {
      // Clear any pending resume timer
      if (resumeTimer) clearTimeout(resumeTimer);

      if (isIdle) {
        isIdle = false;
        document.querySelectorAll('[data-emblem-card]').forEach(card => {
          card.dispatchEvent(new CustomEvent('emblemcard:idle-end'));
        });
      }

      // Set timer to resume floating after inactivity
      resumeTimer = window.setTimeout(() => {
        startFloating();
      }, RESUME_DELAY);
    }

    // Search input
    searchInput.addEventListener('input', () => {
      const { tags, types } = getFiltersFromURL();
      updateURL(searchInput.value, tags, types);
      applyFilters();
      stopFloating();
    });

    // Tags toggle
    tagsToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      const isExpanded = tagsToggle.getAttribute('aria-expanded') === 'true';
      tagsToggle.setAttribute('aria-expanded', String(!isExpanded));
      tagsDropdown.hidden = isExpanded;

      // Close type dropdown when opening tags
      if (!isExpanded) {
        typeToggle.setAttribute('aria-expanded', 'false');
        typeDropdown.hidden = true;
      }
    });

    // Tag pill clicks (event delegation)
    tagsList.addEventListener('click', (e) => {
      const pill = (e.target as HTMLElement).closest('.split-view__tag-pill') as HTMLElement;
      if (!pill) return;

      const tag = pill.dataset.tag;
      if (!tag) return;

      const { search, tags, types } = getFiltersFromURL();

      if (tags.has(tag)) {
        tags.delete(tag);
        pill.classList.remove('is-selected');
      } else {
        tags.add(tag);
        pill.classList.add('is-selected');
      }

      tagsToggle.classList.toggle('has-selection', tags.size > 0);
      updateURL(search, tags, types);
      applyFilters();
    });

    // Clear tags
    tagsClear.addEventListener('click', () => {
      const { search, types } = getFiltersFromURL();
      updateURL(search, new Set(), types);
      tagsList.querySelectorAll('.split-view__tag-pill').forEach((p) => {
        p.classList.remove('is-selected');
      });
      tagsToggle.classList.remove('has-selection');
      applyFilters();
    });

    // Type toggle
    typeToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      const isExpanded = typeToggle.getAttribute('aria-expanded') === 'true';
      typeToggle.setAttribute('aria-expanded', String(!isExpanded));
      typeDropdown.hidden = isExpanded;

      // Close tags dropdown when opening type
      if (!isExpanded) {
        tagsToggle.setAttribute('aria-expanded', 'false');
        tagsDropdown.hidden = true;
      }
    });

    // Type pill clicks (event delegation)
    typesList.addEventListener('click', (e) => {
      const pill = (e.target as HTMLElement).closest('.split-view__type-pill') as HTMLElement;
      if (!pill) return;

      const type = pill.dataset.type;
      if (!type) return;

      const { search, tags, types } = getFiltersFromURL();

      if (types.has(type)) {
        types.delete(type);
        pill.classList.remove('is-selected');
      } else {
        types.add(type);
        pill.classList.add('is-selected');
      }

      typeToggle.classList.toggle('has-selection', types.size > 0);
      updateURL(search, tags, types);
      applyFilters();
    });

    // Clear types
    typeClear.addEventListener('click', () => {
      const { search, tags } = getFiltersFromURL();
      updateURL(search, tags, new Set());
      typesList.querySelectorAll('.split-view__type-pill').forEach((p) => {
        p.classList.remove('is-selected');
      });
      typeToggle.classList.remove('has-selection');
      applyFilters();
    });

    // Clear all filters (both types and tags)
    clearAllButton.addEventListener('click', () => {
      const { search } = getFiltersFromURL();
      updateURL(search, new Set(), new Set());

      // Clear all tag pills
      tagsList.querySelectorAll('.split-view__tag-pill').forEach((p) => {
        p.classList.remove('is-selected');
      });
      tagsToggle.classList.remove('has-selection');

      // Clear all type pills
      typesList.querySelectorAll('.split-view__type-pill').forEach((p) => {
        p.classList.remove('is-selected');
      });
      typeToggle.classList.remove('has-selection');

      applyFilters();
    });

    // Close dropdown when clicking outside (attach once)
    if (!(window as any).__splitViewGlobalHandlers) {
      (window as any).__splitViewGlobalHandlers = true;

      document.addEventListener('click', (e) => {
        const tagsToggle = document.querySelector('.split-view__tags-toggle') as HTMLElement | null;
        const tagsDropdown = document.querySelector('.split-view__tags-dropdown') as HTMLElement | null;
        const typeToggle = document.querySelector('.split-view__type-toggle') as HTMLElement | null;
        const typeDropdown = document.querySelector('.split-view__type-dropdown') as HTMLElement | null;

        if (tagsToggle && tagsDropdown && !tagsToggle.contains(e.target as Node) && !tagsDropdown.contains(e.target as Node)) {
          tagsToggle.setAttribute('aria-expanded', 'false');
          tagsDropdown.hidden = true;
        }

        if (typeToggle && typeDropdown && !typeToggle.contains(e.target as Node) && !typeDropdown.contains(e.target as Node)) {
          typeToggle.setAttribute('aria-expanded', 'false');
          typeDropdown.hidden = true;
        }
      });

      document.addEventListener('keydown', (e) => {
        const search = document.querySelector('.split-view__search') as HTMLInputElement | null;
        const tagsToggle = document.querySelector('.split-view__tags-toggle') as HTMLElement | null;
        const tagsDropdown = document.querySelector('.split-view__tags-dropdown') as HTMLElement | null;
        const typeToggle = document.querySelector('.split-view__type-toggle') as HTMLElement | null;
        const typeDropdown = document.querySelector('.split-view__type-dropdown') as HTMLElement | null;

        if ((e.metaKey || e.ctrlKey) && e.key === 'k' && search) {
          e.preventDefault();
          search.focus();
        }

        if (e.key === 'Escape') {
          if (search && document.activeElement === search && search.value) {
            search.value = '';
            // Update URL and trigger filter
            const params = new URLSearchParams(window.location.search);
            params.delete('search');
            const newURL = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
            history.replaceState(null, '', newURL);
            // Dispatch a custom event to trigger filter update
            window.dispatchEvent(new Event('filterschanged'));
          }
          if (tagsToggle && tagsDropdown) {
            tagsToggle.setAttribute('aria-expanded', 'false');
            tagsDropdown.hidden = true;
          }
          if (typeToggle && typeDropdown) {
            typeToggle.setAttribute('aria-expanded', 'false');
            typeDropdown.hidden = true;
          }
        }
      });

      // Listen for filter changes to reapply
      window.addEventListener('filterschanged', () => {
        const sv = document.querySelector('.split-view');
        if (sv) {
          // Trigger reapply on the current split view
          const event = new CustomEvent('applyfilters');
          sv.dispatchEvent(event);
        }
      });
    }

    // Idle detection event listeners (attach once)
    if (!(window as any).__splitViewIdleHandlers) {
      (window as any).__splitViewIdleHandlers = true;

      // Scroll detection - stops floating
      const detailPanel = splitView?.querySelector('.split-view__detail');
      detailPanel?.addEventListener('scroll', stopFloating, { passive: true });

      // Keyboard input - stops floating
      document.addEventListener('keydown', stopFloating);
    }

    // Emblem hover pauses floating (but NOT general mouse movement)
    document.querySelectorAll('[data-emblem-card]').forEach(card => {
      card.addEventListener('mouseenter', () => {
        // Clear resume timer and pause floating during hover
        if (resumeTimer) clearTimeout(resumeTimer);
        if (isIdle) {
          isIdle = false;
          card.dispatchEvent(new CustomEvent('emblemcard:idle-end'));
        }
      });
      card.addEventListener('mouseleave', () => {
        // Resume floating immediately after hovering emblem
        startFloating();
      });
    });

    // List item clicks
    listItems.forEach((item) => {
      item.addEventListener('click', async (e) => {
        e.preventDefault();
        const slug = item.dataset.slug;
        if (slug) await loadContent(slug);
      });
    });

    // Browser back/forward (attach once per section)
    if (!(window as any)[`__splitViewPopstate_${section}`]) {
      (window as any)[`__splitViewPopstate_${section}`] = true;

      window.addEventListener('popstate', (e) => {
        const sv = document.querySelector('.split-view') as HTMLElement | null;
        if (!sv || sv.dataset.section !== section) return;

        const content = sv.querySelector('.split-view__content') as HTMLElement | null;
        const items = Array.from(sv.querySelectorAll('.list-item')) as HTMLElement[];

        if (e.state?.slug) {
          // Find the loadContent function and call it
          const item = sv.querySelector(`[data-slug="${e.state.slug}"]`) as HTMLElement;
          item?.click();
        } else {
          sv.classList.remove('has-selection');
          if (content) {
            content.classList.remove('is-active');
            content.innerHTML = '';
          }
          items.forEach((i) => i.classList.remove('is-active'));
        }
      });
    }

    // Listen for custom filter apply event
    splitView.addEventListener('applyfilters', () => {
      applyFilters();
    });

    // Scroll detection for visual hierarchy
    if (navContainer && listPanel) {
      let scrollTimeout: number | null = null;

      navContainer.addEventListener('scroll', () => {
        const isScrolled = navContainer.scrollTop > 10;

        if (scrollTimeout) clearTimeout(scrollTimeout);

        scrollTimeout = window.setTimeout(() => {
          listPanel.classList.toggle('is-scrolled', isScrolled);
        }, 50);
      });
    }

    // Keyboard navigation
    const nav = splitView.querySelector('.split-view__nav') as HTMLElement;
    nav?.addEventListener('keydown', (e: KeyboardEvent) => {
      const visibleItems = listItems.filter((item) => !item.classList.contains('is-filtered'));
      if (visibleItems.length === 0) return;

      const activeItem = visibleItems.find((item) => item === document.activeElement || item.classList.contains('is-active'));
      const currentIndex = activeItem ? visibleItems.indexOf(activeItem) : -1;

      switch (e.key) {
        case 'ArrowDown':
          e.preventDefault();
          const nextIndex = currentIndex < visibleItems.length - 1 ? currentIndex + 1 : 0;
          visibleItems[nextIndex].focus();
          break;
        case 'ArrowUp':
          e.preventDefault();
          const prevIndex = currentIndex > 0 ? currentIndex - 1 : visibleItems.length - 1;
          visibleItems[prevIndex].focus();
          break;
        case 'Enter':
        case ' ':
          if (document.activeElement?.classList.contains('list-item')) {
            e.preventDefault();
            (document.activeElement as HTMLElement).click();
          }
          break;
        case 'Home':
          e.preventDefault();
          visibleItems[0]?.focus();
          break;
        case 'End':
          e.preventDefault();
          visibleItems[visibleItems.length - 1]?.focus();
          break;
      }
    });

    // Start floating if initial content is loaded
    if (initialSlug) {
      startFloating();
    }
  }

  // Initialize lightbox for images/videos - called after content loads
  function initMediaLightbox() {
    const proseImages = document.querySelectorAll('.split-view__content .prose img');
    proseImages.forEach((img) => {
      if ((img as HTMLElement).dataset.lightboxInit === 'true') return;
      (img as HTMLElement).dataset.lightboxInit = 'true';

      img.addEventListener('click', () => {
        const src = (img as HTMLImageElement).src;
        const alt = (img as HTMLImageElement).alt || '';
        if (src && window.openMediaLightbox) {
          window.openMediaLightbox(src, alt, 'image');
        }
      });
    });

    const proseVideos = document.querySelectorAll('.split-view__content .prose video');
    proseVideos.forEach((video) => {
      if ((video as HTMLElement).dataset.lightboxInit === 'true') return;
      (video as HTMLElement).dataset.lightboxInit = 'true';

      video.addEventListener('click', () => {
        const src = (video as HTMLVideoElement).src ||
                    (video as HTMLVideoElement).querySelector('source')?.src || '';
        if (src && window.openMediaLightbox) {
          window.openMediaLightbox(src, '', 'video');
        }
      });
    });
  }

  // Prose image 3D tilt effect
  function initProseImageTilt() {
    const proseImages = document.querySelectorAll('.split-view__content .prose img');

    proseImages.forEach((img) => {
      if ((img as HTMLElement).dataset.tiltInit === 'true') return;
      (img as HTMLElement).dataset.tiltInit = 'true';

      let rafId: number | null = null;

      function handleMouseMove(e: MouseEvent) {
        const rect = img.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        const mouseX = e.clientX - centerX;
        const mouseY = e.clientY - centerY;

        // Max 5 degree tilt (subtle)
        const rotateY = (mouseX / (rect.width / 2)) * 5;
        const rotateX = -(mouseY / (rect.height / 2)) * 5;

        if (rafId) cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(() => {
          (img as HTMLElement).style.transform = `
            perspective(800px)
            rotateY(${rotateY}deg)
            rotateX(${rotateX}deg)
            scale(1.03)
          `;
        });
      }

      function handleMouseLeave() {
        if (rafId) cancelAnimationFrame(rafId);
        (img as HTMLElement).style.transform = 'perspective(800px) rotateY(0deg) rotateX(0deg) scale(1)';
      }

      if (window.matchMedia('(hover: hover)').matches) {
        img.addEventListener('mousemove', handleMouseMove as EventListener);
        img.addEventListener('mouseleave', handleMouseLeave);
      }
    });
  }

  // Run on page load
  document.addEventListener('astro:page-load', () => {
    initSplitView();
    initMediaLightbox();
    initProseImageTilt();
  });

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initSplitView();
      initMediaLightbox();
    });
  } else {
    initSplitView();
    initMediaLightbox();
  }
</script>
