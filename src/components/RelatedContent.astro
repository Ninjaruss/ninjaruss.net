---
import type { CollectionEntry } from 'astro:content';

interface Props {
  currentSlug: string;
  currentCollections: string[];
  section: 'media' | 'notes' | 'showcase';
  allReflections: CollectionEntry<'media'>[];
  allNotes: CollectionEntry<'notes'>[];
  allShowcase: CollectionEntry<'showcase'>[];
}

const { currentSlug, currentCollections, section, allReflections, allNotes, allShowcase } = Astro.props;

// Combine all entries from all collections
const allEntries = [
  ...allReflections.map(entry => ({ ...entry, type: 'media' as const })),
  ...allNotes.map(entry => ({ ...entry, type: 'notes' as const })),
  ...allShowcase.map(entry => ({ ...entry, type: 'showcase' as const }))
];

// Calculate relevance and filter related entries
const relatedEntries = allEntries
  .filter(entry => {
    // Filter out current entry
    if (entry.type === section && entry.slug === currentSlug) return false;

    // Filter entries with matching collections
    const entryCollections = entry.data.collections || [];
    const matchCount = entryCollections.filter(col => currentCollections.includes(col)).length;

    return matchCount > 0;
  })
  .map(entry => {
    // Calculate relevance score
    const entryCollections = entry.data.collections || [];
    const score = entryCollections.filter(col => currentCollections.includes(col)).length;
    return { ...entry, score };
  })
  .sort((a, b) => {
    // Sort by score DESC, then by title alphabetically
    if (b.score !== a.score) return b.score - a.score;
    return a.data.title.localeCompare(b.data.title);
  })
  .slice(0, 6); // Limit to 6 results

// Helper to get section display name
const getSectionLabel = (entry: typeof relatedEntries[0]) => {
  // For media entries, show specific content type
  if (entry.type === 'media' && 'content_type' in entry.data) {
    const type = entry.data.content_type;
    return type.charAt(0).toUpperCase() + type.slice(1);
  }

  // For other sections, show generic labels
  const labels = {
    media: 'Media',
    notes: 'Note',
    showcase: 'Project'
  };
  return labels[entry.type];
};
---

{relatedEntries.length > 0 && (
  <footer class="related-content">
    <h2 class="related-content__heading">Related Content</h2>
    <div class="related-content__grid">
      {relatedEntries.map((entry) => (
        <a href={`/${entry.type}/${entry.slug}`} class="related-card">
          {entry.data.emblem && (
            <div class="related-card__emblem">
              <img src={entry.data.emblem} alt="" loading="lazy" />
            </div>
          )}
          <div class="related-card__content">
            <span class="related-card__badge">{getSectionLabel(entry)}</span>
            <h3 class="related-card__title">{entry.data.title}</h3>
          </div>
        </a>
      ))}
    </div>
  </footer>
)}

<style>
  .related-content {
    margin-top: var(--space-3xl);
    padding-top: var(--space-2xl);
    border-top: var(--border-thin) solid var(--color-border);
  }

  .related-content__heading {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    color: var(--color-text);
    margin-bottom: var(--space-lg);
  }

  .related-content__grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: var(--space-md);
  }

  .related-card {
    display: flex;
    flex-direction: column;
    background: var(--color-bg-elevated);
    border: var(--border-medium) solid var(--color-border-strong);
    border-radius: var(--radius-md);
    overflow: hidden;
    box-shadow: var(--shadow-hard-sm);
    aspect-ratio: 63 / 88;
    position: relative;
    transition:
      transform var(--transition-base),
      box-shadow var(--transition-base),
      border-color var(--transition-base);
    text-decoration: none;
    color: inherit;
  }

  .related-card:hover {
    transform: translate(-2px, -2px) rotate(0.5deg) scale(1.02);
    box-shadow: var(--shadow-hard);
    border-color: var(--color-gold);
  }

  .related-card__emblem {
    width: 100%;
    height: 120px;
    overflow: hidden;
    background: var(--color-bg-surface);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .related-card__emblem img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.85;
    transition: opacity var(--transition-base);
  }

  .related-card:hover .related-card__emblem img {
    opacity: 1;
  }

  .related-card__content {
    padding: var(--space-sm);
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    flex: 1;
  }

  .related-card__badge {
    display: inline-block;
    align-self: flex-start;
    background: var(--color-black);
    color: var(--color-gold);
    padding: var(--space-2xs) var(--space-xs);
    font-family: var(--font-display);
    font-size: var(--text-2xs);
    text-transform: uppercase;
    letter-spacing: var(--tracking-label);
    border-radius: var(--radius-xs);
  }

  .related-card__title {
    font-family: var(--font-display);
    font-size: var(--text-sm);
    line-height: 1.3;
    color: var(--color-text);
    transition: color var(--transition-fast);
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .related-card:hover .related-card__title {
    color: var(--color-gold);
  }

  @media (max-width: 768px) {
    .related-content__grid {
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: var(--space-sm);
    }
  }

  @media (max-width: 480px) {
    .related-content__grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .related-card:hover {
      transform: translate(-2px, -2px);
    }
  }
</style>
