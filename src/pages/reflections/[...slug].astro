---
import { getCollection } from 'astro:content';
import SplitViewLayout from '../../layouts/SplitViewLayout.astro';
import ListItem from '../../components/ListItem.astro';
import StatusBadge from '../../components/StatusBadge.astro';
import TagList from '../../components/TagList.astro';
import DateDisplay from '../../components/DateDisplay.astro';

export async function getStaticPaths() {
  const entries = await getCollection('reflections');
  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// Get all reflections for the list
const allMedia = await getCollection('reflections', ({ data }) => !data.draft);
const sortedMedia = allMedia.sort((a, b) => a.data.title.localeCompare(b.data.title));

const meta: Record<string, string> = {};
if (entry.data.reflections_type) {
  meta['Type'] = entry.data.reflections_type.charAt(0).toUpperCase() + entry.data.reflections_type.slice(1);
}
---

<SplitViewLayout
  title="Reflections"
  description="Notes on anime, manga, and films."
  section="reflections"
  initialSlug={entry.slug}
>
  <Fragment slot="list">
    {sortedMedia.map((reflectionsEntry) => (
      <ListItem
        href={`/reflections/${reflectionsEntry.slug}`}
        slug={reflectionsEntry.slug}
        title={reflectionsEntry.data.title}
        status={reflectionsEntry.data.status}
        tags={reflectionsEntry.data.tags}
      />
    ))}
  </Fragment>

  <Fragment slot="detail">
    <article class="entry">
      <div class="container">
        <header class="entry__header">
          <h1 class="entry__title">{entry.data.title}</h1>
          <div class="entry__meta">
            <StatusBadge status={entry.data.status} size="md" />
            <TagList tags={entry.data.tags} size="md" />
            <DateDisplay date={entry.data.publishedAt} updatedAt={entry.data.updatedAt} size="md" />
          </div>
          {meta && Object.keys(meta).length > 0 && (
            <dl class="entry__details">
              {Object.entries(meta).map(([key, value]) => (
                <>
                  <dt>{key}</dt>
                  <dd>{value}</dd>
                </>
              ))}
            </dl>
          )}
        </header>

        <div class="entry__body">
          <div class="entry__content prose">
            <Content />
          </div>
        </div>
      </div>
    </article>
  </Fragment>
</SplitViewLayout>
