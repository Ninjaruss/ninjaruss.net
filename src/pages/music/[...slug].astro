---
import { getCollection } from 'astro:content';
import SplitViewLayout from '../../layouts/SplitViewLayout.astro';
import ListItem from '../../components/ListItem.astro';
import StatusBadge from '../../components/StatusBadge.astro';
import TagList from '../../components/TagList.astro';

export async function getStaticPaths() {
  const entries = await getCollection('music');
  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// Get all music for the list
const allMusic = await getCollection('music', ({ data }) => !data.draft);
const sortedMusic = allMusic.sort((a, b) => a.data.title.localeCompare(b.data.title));

const meta: Record<string, string> = {};
if (entry.data.mood) {
  meta['Mood'] = entry.data.mood;
}
---

<SplitViewLayout
  title="Music"
  description="Curated song collections."
  section="music"
  initialSlug={entry.slug}
>
  <Fragment slot="list">
    {sortedMusic.map((musicEntry) => (
      <ListItem
        href={`/music/${musicEntry.slug}`}
        slug={musicEntry.slug}
        title={musicEntry.data.title}
        status={musicEntry.data.status}
      />
    ))}
  </Fragment>

  <Fragment slot="detail">
    <article class="entry">
      <div class="container">
        <header class="entry__header">
          <h1 class="entry__title">{entry.data.title}</h1>
          <div class="entry__meta">
            <StatusBadge status={entry.data.status} size="md" />
            <TagList tags={entry.data.emotional_tags} size="md" />
          </div>
          {meta && Object.keys(meta).length > 0 && (
            <dl class="entry__details">
              {Object.entries(meta).map(([key, value]) => (
                <>
                  <dt>{key}</dt>
                  <dd>{value}</dd>
                </>
              ))}
            </dl>
          )}
          {entry.data.thumbnails && entry.data.thumbnails.length > 0 && (
            <div class="entry__thumbnails">
              {entry.data.thumbnails.map((thumb) => (
                <img
                  src={thumb.src}
                  alt={thumb.alt || entry.data.title}
                  class="entry__thumbnail"
                  data-lightbox-src={thumb.src}
                  data-lightbox-alt={thumb.alt || entry.data.title}
                />
              ))}
            </div>
          )}
        </header>

        <div class="entry__body">
          <div class="entry__content prose">
            <Content />

            {entry.data.tracks && entry.data.tracks.length > 0 && (
              <section class="tracklist">
                <h3>Tracks</h3>
                <ol>
                  {entry.data.tracks.map((track) => (
                    <li>
                      <span class="track__title">{track.title}</span>
                      <span class="track__artist">{track.artist}</span>
                      {track.link && (
                        <a href={track.link} target="_blank" rel="noopener noreferrer" class="track__link">
                          Listen
                        </a>
                      )}
                    </li>
                  ))}
                </ol>
              </section>
            )}
          </div>
        </div>
      </div>
    </article>
  </Fragment>
</SplitViewLayout>

<style>
  .tracklist {
    margin-top: var(--space-2xl);
    padding-top: var(--space-xl);
    border-top: 1px solid var(--color-border);
  }

  .tracklist h3 {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    margin-bottom: var(--space-md);
  }

  .tracklist ol {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    counter-reset: track;
  }

  .tracklist li {
    display: flex;
    align-items: baseline;
    gap: var(--space-sm);
    padding: var(--space-sm) 0;
    border-bottom: 1px solid var(--color-border);
    counter-increment: track;
  }

  .tracklist li::before {
    content: counter(track) ".";
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--color-muted);
    min-width: 2ch;
  }

  .track__title {
    font-weight: 500;
    color: var(--color-charcoal);
  }

  .track__artist {
    color: var(--color-muted);
    font-size: var(--text-sm);
  }

  .track__link {
    margin-left: auto;
    font-size: var(--text-xs);
    color: var(--color-gold-dark);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
</style>
