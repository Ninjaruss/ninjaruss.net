---
import { getCollection } from 'astro:content';
import SplitViewLayout from '../../layouts/SplitViewLayout.astro';
import ListItem from '../../components/ListItem.astro';
import EntryHeader from '../../components/EntryHeader.astro';
import EntryBody from '../../components/EntryBody.astro';
import RelatedContent from '../../components/RelatedContent.astro';
import { stripMarkdown, hasMinimalContent } from '../../utils/content';
import { getAllCollections, getSortedEntries } from '../../utils/collections';

export async function getStaticPaths() {
  const entries = await getCollection('media');
  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const sortedMedia = await getSortedEntries('media');
const { allMedia, allNotes, allShowcase } = await getAllCollections();
const hasContent = !hasMinimalContent(entry.body);
---

<SplitViewLayout
  title="Media"
  description="Notes on anime, manga, films, and more."
  section="media"
  initialSlug={entry.slug}
  initialEmblem={entry.data.emblem}
>
  <Fragment slot="list">
    {sortedMedia.map((mediaEntry) => (
      <ListItem
        href={`/media/${mediaEntry.slug}`}
        slug={mediaEntry.slug}
        title={mediaEntry.data.title}
        tags={mediaEntry.data.tags}
        searchableContent={stripMarkdown(mediaEntry.body || '').slice(0, 500)}
        contentType={mediaEntry.data.content_type}
        hasMinimalContent={hasMinimalContent(mediaEntry.body)}
      />
    ))}
  </Fragment>

  <Fragment slot="detail">
    <article class="entry">
      <div class="container">
        <EntryHeader
          title={entry.data.title}
          tags={entry.data.tags}
          publishedAt={entry.data.publishedAt}
          updatedAt={entry.data.updatedAt}
          emblem={entry.data.emblem}
        />
        <EntryBody hasContent={hasContent}>
          <Content />
        </EntryBody>
        {entry.data.collections.length > 0 && (
          <RelatedContent
            currentSlug={entry.slug}
            currentCollections={entry.data.collections}
            section="media"
            allMedia={allMedia}
            allNotes={allNotes}
            allShowcase={allShowcase}
          />
        )}
      </div>
    </article>
  </Fragment>
</SplitViewLayout>
