---
import { getCollection } from 'astro:content';
import SplitViewLayout from '../../layouts/SplitViewLayout.astro';
import ListItem from '../../components/ListItem.astro';
import TagList from '../../components/TagList.astro';
import RelatedContent from '../../components/RelatedContent.astro';
import { stripMarkdown, hasMinimalContent } from '../../utils/content';

export async function getStaticPaths() {
  const entries = await getCollection('showcase');
  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// Get all showcase for the list
const allExperiments = await getCollection('showcase', ({ data }) => !data.draft);
const sortedExperiments = allExperiments.sort((a, b) => a.data.title.localeCompare(b.data.title));

// Fetch all collections for related content
const allMedia = await getCollection('media', ({ data }) => !data.draft);
const allNotes = await getCollection('notes', ({ data }) => !data.draft);
const allShowcase = allExperiments;

const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    timeZone: 'UTC',
  });
};

// Only use explicit updatedAt from frontmatter
const updatedAt = entry.data.updatedAt;

// Check if entry has substantial content
const hasContent = !hasMinimalContent(entry.body);
---

<SplitViewLayout
  title="Showcase"
  description="Projects framed as inquiries."
  section="showcase"
  initialSlug={entry.slug}
  initialEmblem={entry.data.emblem}
>
  <Fragment slot="list">
    {sortedExperiments.map((exp) => (
      <ListItem
        href={`/showcase/${exp.slug}`}
        slug={exp.slug}
        title={exp.data.title}
        tags={exp.data.tags}
        searchableContent={stripMarkdown(exp.body).slice(0, 500)}
        hasMinimalContent={hasMinimalContent(exp.body)}
      />
    ))}
  </Fragment>

  <Fragment slot="detail">
    <article class="entry">
      {entry.data.emblem && <span data-page-emblem data-src={entry.data.emblem} hidden />}
      <div class="container">
        <header class="entry__header">
          <h1 class="entry__title">{entry.data.title}</h1>
          <div class="entry__meta">
            {entry.data.tags.length > 0 && (
              <div class="entry__meta-row">
                <TagList tags={entry.data.tags} size="md" />
              </div>
            )}
            {(entry.data.publishedAt || (updatedAt && entry.data.publishedAt && updatedAt > entry.data.publishedAt)) && (
              <div class="entry__meta-dates">
                {entry.data.publishedAt && (
                  <div class="meta-date-item">
                    <span class="meta-date-label">Published</span>
                    <span class="meta-date-value">{formatDate(entry.data.publishedAt)}</span>
                  </div>
                )}
                {updatedAt && entry.data.publishedAt && updatedAt > entry.data.publishedAt && (
                  <div class="meta-date-item">
                    <span class="meta-date-label">Last Edited</span>
                    <span class="meta-date-value">{formatDate(updatedAt)}</span>
                  </div>
                )}
              </div>
            )}
          </div>
        </header>

        {hasContent && (
          <div class="entry__body">
            <div class="entry__content prose">
              <Content />
            </div>
          </div>
        )}

        {entry.data.collections.length > 0 && (
          <RelatedContent
            currentSlug={entry.slug}
            currentCollections={entry.data.collections}
            section="showcase"
            allMedia={allMedia}
            allNotes={allNotes}
            allShowcase={allShowcase}
          />
        )}
      </div>
    </article>
  </Fragment>
</SplitViewLayout>
