---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import BentoGrid from '../components/BentoGrid.astro';
import BentoTile from '../components/BentoTile.astro';

// Query all content collections for items with publishedAt dates
const notes = await getCollection('notes', ({ data }) => !data.draft && data.publishedAt);
const reflections = await getCollection('reflections', ({ data }) => !data.draft && data.publishedAt);
const showcase = await getCollection('showcase', ({ data }) => !data.draft && data.publishedAt);

// Find the most recently published content
const allContent = [...notes, ...reflections, ...showcase];
const mostRecent = allContent
  .sort((a, b) => new Date(b.data.publishedAt!).getTime() - new Date(a.data.publishedAt!).getTime())[0];

const recentHref = mostRecent ? `/${mostRecent.collection}/${mostRecent.slug}` : undefined;

// Calculate "X days ago" for latest content
const getDaysAgo = (date: Date) => {
  // Create date objects at midnight local time for accurate day comparison
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const compareDate = new Date(date);
  compareDate.setHours(0, 0, 0, 0);

  const diffMs = today.getTime() - compareDate.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return 'today';
  if (diffDays === 1) return 'yesterday';
  return `${diffDays} days ago`;
};

const daysAgo = mostRecent ? getDaysAgo(new Date(mostRecent.data.publishedAt!)) : '';
---

<BaseLayout title="Home" description="Fragments, reflections, and showcase.">
  <div class="container">
    <BentoGrid>
      <!-- Row 1-2: Title Hero (3x2) + YouTube Hero #1 (3x2) -->
      <div class="title-tile bento-tile--span-3x2 p3r-animate-left">
        <span class="title-tile__name">Ninjaruss</span>
      </div>

      <div class="image-tile image-tile--youtube bento-tile--span-3x2 p3r-animate" style="--stagger-delay: 100ms;">
        <a href="https://www.youtube.com/@Ninjaruss_" target="_blank" rel="noopener noreferrer">
          <img
            src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fi.ytimg.com%2Fvi%2FHCc3Ol7adcw%2Fmaxresdefault.jpg&f=1&nofb=1&ipt=3af1979f6b60ed9a8bb7f3ff02d25d81b2b98005b38c7a5b9f2bc4d6f8bb3aa9"
            alt="Hero visual"
            class="image-tile__img"
          />
          <div class="image-tile__youtube-overlay">
            <svg class="image-tile__youtube-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
            </svg>
          </div>
        </a>
      </div>

      <!-- Row 3-4: Showcase (3x2) + Notes (3x2) -->
      <BentoTile
        href="/showcase"
        variant="highlight"
        accent
        label="Showcase"
        title="What I'm Building"
        description="Projects framed as inquiries."
        class="bento-tile--core bento-tile--span-3x2"
      />

      <BentoTile
        href="/notes"
        variant="dark"
        accent
        label="Notes"
        title="Thoughts in Progress"
        description="Philosophical fragments. Contradictions allowed."
        class="bento-tile--core bento-tile--span-3x2"
      />

      <!-- Row 5-6: Reflections (2x2) + Latest (2x1) + Now (2x1) -->
      <BentoTile
        href="/reflections"
        accent
        label="Reflections"
        title="Watched & Read"
        description="Anime, manga, and film notes."
        class="bento-tile--core bento-tile--span-2x2"
      />

      {mostRecent && (
        <BentoTile
          href={recentHref}
          variant="dark"
          accent
          label="Latest"
          title={mostRecent.data.title}
          class="bento-tile--span-2x1"
        >
          <span class="days-ago">{daysAgo}</span>
        </BentoTile>
      )}

      <BentoTile
        href="/now"
        variant="highlight"
        label="Now"
        title="Current Focus"
        class="bento-tile--span-2x1"
      />

      <!-- Row 7-8: YouTube Hero #2 (3x2) + Mini Tiles (2x1 each) -->
      <div class="image-tile image-tile--youtube bento-tile--span-3x2 p3r-animate" style="--stagger-delay: 100ms;">
        <a href="https://www.youtube.com/@kaima-mask" target="_blank" rel="noopener noreferrer">
          <img
            src="https://yt3.ggpht.com/1ThFXMWuqv4QV_DlxmGVxKgNNW6bWWSpETC5uEOleDcM_T07zT3xtueJ-fW1-SCQhgaXA7DtrQ=s600-c-k-c0x00ffffff-no-rj-rp-mo"
            alt="Hero visual"
            class="image-tile__img"
          />
          <div class="image-tile__youtube-overlay">
            <svg class="image-tile__youtube-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
            </svg>
          </div>
        </a>
      </div>
    </BentoGrid>
  </div>
</BaseLayout>

<style>
  .container {
    padding-top: var(--space-sm);
    padding-bottom: var(--space-md);
  }

  /* Days ago indicator for Latest tile */
  .days-ago {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-transform: lowercase;
  }

  /* Title Tile - Part of the bento grid */
  .title-tile {
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-black);
    border: var(--border-thick) solid var(--color-gold);
    border-radius: var(--radius-lg);
    padding: var(--space-md);
    grid-column: span 2;
    grid-row: span 1;
    box-shadow: var(--shadow-glow);
    overflow: hidden;
  }

  .title-tile__name {
    font-family: var(--font-display);
    font-size: clamp(2.5rem, 5vw, 4rem);
    font-weight: 700;
    color: var(--color-gold);
    letter-spacing: 0.02em;
    text-shadow:
      0 0 30px rgba(255, 229, 44, 0.6),
      0 0 60px rgba(255, 229, 44, 0.3);
  }

  /* Image Tile */
  .image-tile {
    grid-column: span 1;
    grid-row: span 1;
    border-radius: var(--radius-lg);
    overflow: hidden;
    border: var(--border-thick) solid var(--color-border-strong);
    background: var(--color-bg-elevated);
    position: relative;
    box-shadow: var(--shadow-hard);
    transition:
      transform var(--transition-fast),
      box-shadow var(--transition-fast),
      border-color var(--transition-fast);
  }

  .image-tile:hover {
    transform: translate(-2px, -2px);
    box-shadow: var(--shadow-hard-hover);
    border-color: var(--color-gold);
  }

  .image-tile:active {
    transform: translate(0, 0);
    box-shadow: var(--shadow-hard-sm);
  }

  .image-tile a {
    display: block;
    width: 100%;
    height: 100%;
    position: relative;
  }

  .image-tile__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: filter var(--transition-fast);
  }

  .image-tile:hover .image-tile__img {
    filter: brightness(0.8);
  }

  /* YouTube Overlay */
  .image-tile__youtube-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.5);
    opacity: 0;
    transition: opacity var(--transition-fast);
  }

  .image-tile--youtube:hover .image-tile__youtube-overlay {
    opacity: 1;
  }

  .image-tile__youtube-icon {
    width: 64px;
    height: 64px;
    color: #ff0000;
    filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.5));
    transition: transform var(--transition-fast);
  }

  .image-tile--youtube:hover .image-tile__youtube-icon {
    transform: scale(1.1);
  }

  @media (max-width: 768px) {
    .title-tile {
      grid-column: span 2;
      padding: var(--space-lg);
    }

    .title-tile__name {
      font-size: clamp(1.8rem, 8vw, 2.5rem);
    }

    .image-tile {
      grid-column: span 2;
      min-height: 200px;
    }

    .image-tile__youtube-icon {
      width: 48px;
      height: 48px;
    }
  }

  @media (max-width: 480px) {
    .title-tile {
      grid-column: span 1;
    }

    .title-tile__name {
      font-size: clamp(1.5rem, 6vw, 2rem);
    }

    .image-tile {
      grid-column: span 1;
    }

    .image-tile__youtube-icon {
      width: 40px;
      height: 40px;
    }
  }
</style>
