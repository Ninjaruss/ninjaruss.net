---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import BentoGrid from '../components/BentoGrid.astro';
import BentoTile from '../components/BentoTile.astro';

// Query all content collections for items with publishedAt dates
const notes = await getCollection('notes', ({ data }) => !data.draft && data.publishedAt);
const media = await getCollection('media', ({ data }) => !data.draft && data.publishedAt);
const showcase = await getCollection('showcase', ({ data }) => !data.draft && data.publishedAt);

// Query now collection for latest entry
const allNow = await getCollection('now', ({ data }) => !data.draft);
const latestNow = allNow.sort((a, b) =>
  new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime()
)[0];

// Format month and year for now tile
const nowDate = latestNow?.data.publishedAt;
const nowMonthYear = nowDate
  ? nowDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
  : '';

// Find the most recently published content
const allContent = [...notes, ...media, ...showcase];
const mostRecent = allContent
  .sort((a, b) => new Date(b.data.publishedAt!).getTime() - new Date(a.data.publishedAt!).getTime())[0];

const recentHref = mostRecent ? `/${mostRecent.collection}/${mostRecent.slug}` : undefined;

// Calculate "X days ago" for latest content
const getDaysAgo = (date: Date) => {
  const today = new Date();
  const compareDate = new Date(date);

  // Use UTC to avoid timezone issues
  const todayUTC = Date.UTC(today.getFullYear(), today.getMonth(), today.getDate());
  const compareUTC = Date.UTC(compareDate.getFullYear(), compareDate.getMonth(), compareDate.getDate());

  const diffMs = todayUTC - compareUTC;
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return 'today';
  if (diffDays === 1) return 'yesterday';
  return `${diffDays} days ago`;
};

const daysAgo = mostRecent ? getDaysAgo(new Date(mostRecent.data.publishedAt!)) : '';
---

<BaseLayout title="Home" description="Fragments, reflections, and showcase.">
  <div class="container">
    <BentoGrid>
      <!-- Row 1-2: Title Hero (3x2) + YouTube Hero #1 (3x2) -->
      <div class="title-tile bento-tile--span-3x2 p3r-animate-left">
        <span class="title-tile__name">Ninjaruss</span>
        <p class="title-tile__description">Live without regret.</p>
      </div>

      <div class="image-tile image-tile--youtube bento-tile--span-3x2 p3r-animate" style="--stagger-delay: 100ms;">
        <a href="https://www.youtube.com/@Ninjaruss_" target="_blank" rel="noopener noreferrer">
          <img
            src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fi.ytimg.com%2Fvi%2FHCc3Ol7adcw%2Fmaxresdefault.jpg&f=1&nofb=1&ipt=3af1979f6b60ed9a8bb7f3ff02d25d81b2b98005b38c7a5b9f2bc4d6f8bb3aa9"
            alt="Hero visual"
            class="image-tile__img"
          />
          <div class="image-tile__youtube-overlay">
            <svg class="image-tile__youtube-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
            </svg>
          </div>
        </a>
      </div>

      <!-- Row 3-4: Showcase (3x2) + Notes (3x2) -->
      <BentoTile
        href="/showcase"
        variant="highlight"
        accent
        label="Showcase"
        title="What I'm Building"
        description="Stuff I've created and that I am currently working on."
        class="bento-tile--core bento-tile--span-3x2"
      />

      <BentoTile
        href="/notes"
        variant="dark"
        label="Notes"
        title="Thoughts in Progress"
        description="An assortment of ideas I've been thinking about."
        class="bento-tile--core bento-tile--span-3x2"
      />

      <!-- Row 5-6: Media (2x2) + Latest (2x1) + Now (2x1) -->
      <BentoTile
        href="/media"
        variant="dark"
        label="Media"
        title="Watched & Read"
        description="My thoughts on anime, manga, movies, and more."
        class="bento-tile--core bento-tile--span-2x2"
      />

      {mostRecent && (
        <BentoTile
          href={recentHref}
          variant="dark"
          accent
          label="Latest"
          title={mostRecent.data.title}
          class="bento-tile--span-2x1"
        >
          <span class="days-ago">{daysAgo}</span>
        </BentoTile>
      )}

      <BentoTile
        href="/now"
        variant="highlight"
        label="Now"
        title="Current Focus"
        class="bento-tile--span-2x1"
        description="Where am I at right now?"
      >
        <span class="now-date">{nowMonthYear}</span>
      </BentoTile>

      <BentoTile
        href="/favorites"
        variant="dark"
        label="Favorites"
        title="Inspirations"
        description="My favorite characters, series, and soundtracks."
      />

      <a
        href="https://myanimelist.net/animelist/Ninjaruss_?status=7&order=4&order2=0"
        target="_blank"
        rel="noopener noreferrer"
        class="logo-tile p3r-animate"
        style="--stagger-delay: 100ms;"
      >
        <img
          src="/images/logos/myanimelist.svg"
          alt="MyAnimeList"
          class="logo-tile__img"
        />
        <span class="logo-tile__label">MyAnimeList</span>
        <p class="logo-tile__description">Anime I've watched and rated based on personal enjoyment.</p>
      </a>

      <a
        href="https://open.spotify.com/playlist/6PYIeR2dXsbTrk47TqetSD?si=2b68cabcfc26451c"
        target="_blank"
        rel="noopener noreferrer"
        class="logo-tile p3r-animate"
        style="--stagger-delay: 150ms;"
      >
        <img
          src="/images/logos/spotify.svg"
          alt="Spotify Playlist"
          class="logo-tile__img"
        />
        <span class="logo-tile__label">Spotify</span>
        <p class="logo-tile__description">The bangers I listen to every day.</p>
      </a>

      <!-- Row 7-8: YouTube Hero #2 (3x2) + Mini Tiles (2x1 each) -->
      <div class="image-tile image-tile--youtube bento-tile--span-3x2 p3r-animate" style="--stagger-delay: 100ms;">
        <a href="https://www.youtube.com/@kaima-mask" target="_blank" rel="noopener noreferrer">
          <img
            src="https://yt3.ggpht.com/1ThFXMWuqv4QV_DlxmGVxKgNNW6bWWSpETC5uEOleDcM_T07zT3xtueJ-fW1-SCQhgaXA7DtrQ=s600-c-k-c0x00ffffff-no-rj-rp-mo"
            alt="Hero visual"
            class="image-tile__img"
          />
          <div class="image-tile__youtube-overlay">
            <svg class="image-tile__youtube-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
            </svg>
          </div>
        </a>
      </div>
    </BentoGrid>
  </div>
</BaseLayout>

<style>
  .container {
    padding-top: var(--space-sm);
    padding-bottom: var(--space-md);
  }

  /* Days ago indicator for Latest tile */
  .days-ago {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-transform: lowercase;
  }

  /* Month/year indicator for Now tile */
  .now-date {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--color-black);
    text-transform: lowercase;
  }

  /* Logo Tiles (MyAnimeList, Spotify) */
  .logo-tile {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    padding: var(--space-md);
    background: var(--color-bg-elevated);
    border: var(--border-medium) solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-base);
    min-height: 80px;
  }

  .logo-tile:hover {
    transform: translate(-2px, -2px);
    border-color: var(--color-gold);
    box-shadow:
      4px 4px 0 rgba(255, 229, 44, 0.3),
      0 0 20px rgba(255, 229, 44, 0.15);
  }

  .logo-tile:focus-visible {
    outline: 2px solid var(--color-gold);
    outline-offset: 2px;
  }

  .logo-tile__img {
    width: 48px;
    height: 48px;
    object-fit: contain;
  }

  .logo-tile__label {
    font-family: var(--font-display);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: var(--tracking-label);
    text-align: center;
  }

  .logo-tile:hover .logo-tile__label {
    color: var(--color-gold);
  }

  .logo-tile__description {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: var(--space-xs);
    line-height: 1.4;
    text-align: center;

    /* Hidden by default, revealed on hover with 400ms delay */
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    transition:
      opacity 200ms ease-out 400ms,
      max-height 300ms ease-out 0ms;
  }

  .logo-tile:hover .logo-tile__description {
    opacity: 1;
    max-height: 100px;
  }

  /* Instant hide on mouse out (remove delay) */
  .logo-tile:not(:hover) .logo-tile__description {
    transition-delay: 0ms;
  }

  /* Title Tile - Part of the bento grid */
  .title-tile {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--color-black);
    border: var(--border-thick) solid var(--color-gold);
    border-radius: var(--radius-lg);
    padding: var(--space-md);
    grid-column: span 2;
    grid-row: span 1;
    box-shadow: var(--shadow-glow);
    overflow: hidden;
    opacity: 1;
    transition: opacity var(--transition-base);
  }

  .title-tile__name {
    font-family: var(--font-display);
    font-size: clamp(2.5rem, 5vw, 4rem);
    font-weight: 700;
    color: var(--color-gold);
    letter-spacing: 0.02em;
    text-shadow:
      0 0 30px rgba(255, 229, 44, 0.6),
      0 0 60px rgba(255, 229, 44, 0.3);
  }

  .title-tile__description {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin-top: var(--space-xs);
    line-height: 1.4;
    text-align: center;

    /* Hidden by default, revealed on hover with 400ms delay */
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    transition:
      opacity 200ms ease-out 400ms,
      max-height 300ms ease-out 0ms;
  }

  .title-tile:hover .title-tile__description {
    opacity: 1;
    max-height: 100px;
  }

  /* Instant hide on mouse out (remove delay) */
  .title-tile:not(:hover) .title-tile__description {
    transition-delay: 0ms;
  }

  /* Image Tile */
  .image-tile {
    grid-column: span 1;
    grid-row: span 1;
    border-radius: var(--radius-lg);
    overflow: hidden;
    border: var(--border-thick) solid var(--color-border-strong);
    background: var(--color-bg-elevated);
    position: relative;
    box-shadow: var(--shadow-hard);
    opacity: 1;
    transition:
      opacity var(--transition-base),
      transform var(--transition-fast),
      box-shadow var(--transition-fast),
      border-color var(--transition-fast);
  }

  .image-tile:hover {
    transform: translate(-2px, -2px);
    box-shadow: var(--shadow-hard-hover);
    border-color: var(--color-gold);
  }

  .image-tile:active {
    transform: translate(0, 0);
    box-shadow: var(--shadow-hard-sm);
  }

  .image-tile a {
    display: block;
    width: 100%;
    height: 100%;
    position: relative;
  }

  .image-tile__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: filter var(--transition-fast);
  }

  .image-tile:hover .image-tile__img {
    filter: brightness(0.8);
  }

  /* YouTube Overlay */
  .image-tile__youtube-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.5);
    opacity: 0;
    transition: opacity var(--transition-fast);
  }

  .image-tile--youtube:hover .image-tile__youtube-overlay {
    opacity: 1;
  }

  .image-tile__youtube-icon {
    width: 64px;
    height: 64px;
    color: #ff0000;
    filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.5));
    transition: transform var(--transition-fast);
  }

  .image-tile--youtube:hover .image-tile__youtube-icon {
    transform: scale(1.1);
  }

  /* Reduced Motion Support */
  @media (prefers-reduced-motion: reduce) {
    .title-tile__description,
    .logo-tile__description {
      transition: opacity 100ms ease-out 0ms;
    }

    .title-tile:hover .title-tile__description,
    .logo-tile:hover .logo-tile__description {
      transition-delay: 0ms;
    }
  }

  @media (max-width: 768px) {
    .title-tile {
      grid-column: span 2;
      padding: var(--space-lg);
    }

    .title-tile__name {
      font-size: clamp(1.8rem, 8vw, 2.5rem);
    }

    .image-tile {
      grid-column: span 2;
      min-height: 200px;
    }

    .image-tile__youtube-icon {
      width: 48px;
      height: 48px;
    }
  }

  @media (max-width: 480px) {
    .title-tile {
      grid-column: span 1;
    }

    .title-tile__name {
      font-size: clamp(1.5rem, 6vw, 2rem);
    }

    .image-tile {
      grid-column: span 1;
    }

    .image-tile__youtube-icon {
      width: 40px;
      height: 40px;
    }
  }
</style>
